#include <AT89X52.h>

#define Total 4 // 图像组数
#define Resolution 64 // 分辨率
#define Delay_Time 1 // 每2列之间的延迟
#define Button P1_0 // 图像切换按键

/*** 全局变量 ***/
unsigned short current = 0; // 记录当前图片索引
/*** 中断状态 ***/
// 0 为从右往左,不显示图像
// 1 为从左往右,显示图像
unsigned char state = 0;

/*** 声明图像信息 ***/
extern unsigned short code img[Total][Resolution];

/*** 声明助手函数 ***/
void flash(int n);
void delay(unsigned int t);
void init_interruptt();
void next_img();
void show(unsigned int n);
void show_col(unsigned short i);

int main(){
	current = 0;
	init_interruptt(); // 初始化外部中断

	flash(3); // 闪烁以示启动成功

	while(1){
		if (Button == 0){ // 按键按下
			delay(10); // 消抖
			if (Button == 0){
				while (Button == 0) // 等待按键弹起
					delay(10);

				next_img(); // 切换下一组图像
			}
		}
	}

	return 0;
}

/*** 闪烁函数 ***/
/* 参数 n : 闪烁次数 */
void flash(int n){
	int i;
	for (i = 0; i < n; i++){
		show_col(0x0000); // 灯全亮
		delay(500);
		show_col(0xFFFF); // 灯全灭
		delay(500);
	}
}

/*** 延迟函数 ***/
void delay(unsigned int t){
	unsigned int i, j;
	for (i = 0; i < t; i++)
		for (j = 0; j < 50; j++) // 此处准确数据待测
			; // Do nothing
}

/*** 外部中断 初始化函数 ***/
void init_interruptt(){
	/*** 外部中断0 ***/
	/*** 由水银开关控制, 显示一组图像 ***/
	IT0 = 1; // 下降沿触发
	EX0 = 1; // 开启外部中断

	EA = 1; // 外部中断总开关
}

/*** 外部中断0 执行函数 ***/
void into_init_0() interrupt 0{
	EX0 = 0; // 关闭外部中断0

	state = ~state; // 改变状态记录
	if (state)
		show(current); // 显示一组图像

	EX0 = 1; // 关闭外部中断0
}

/*** 切换下一组图像 ***/
void next_img(){
	current = (current + 1) % Total; // 切换下一组图像

	flash(2); // 闪烁以示切换成功
}

/*** 图像显示函数 ***/
/* 参数 index : 图像索引 */
void show(unsigned short index){
	unsigned short i;
	for (i = 0; i < Resolution; i++){
		show_col(img[index][i]); // 循环显示一列
		delay(Delay_Time); // 列与列之间延迟
	}

	show_col(0xFFFF); // 关闭所有灯
}

/*** 列显示函数 ***/
void show_col(unsigned short col){
	P0 = col / 256; // 改变 P0 的8个Led灯
	P2 = col % 256; // 改变 P2 的8个Led灯
}

/*** 图像信息 ***/
unsigned short code img[Total][Resolution] = {
// 第0组
{0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0x1FE3, 0x1FE3, 0x1FE3, 0xFFE7,
 0xFFE7, 0xFFE7, 0xFFE7, 0xFFE7, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF,
 0x7FF7, 0x3F77, 0xDFFB, 0x5FE3, 0x1FE3, 0x1FE3, 0x1FE3, 0x5FE3,
 0xDFFB, 0x3F77, 0x7FF7, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0xBF17,
 0x5F9B, 0x3F03, 0x7F5F, 0xFFCF, 0xFFEF, 0xFFF7, 0xFFEF, 0xFFCF,
 0x7F5F, 0x3F03, 0x5F9B, 0xBF17, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF,
 0x1FE3, 0x1FE3, 0xDF7F, 0xDF7F, 0xDF7F, 0xDF7F, 0xDF7F, 0xDF7F,
 0xDF7F, 0x3FFF, 0x3FFF, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF},
// 第1组
{0xFFFF, 0xFFFF, 0xFFFF, 0x3FFF, 0x3FFF, 0x3FFF, 0x3FFF, 0x3FFF,
 0x3FFF, 0x3FFF, 0x3FFF, 0x5FFF, 0xDFE7, 0x3F7F, 0x3F7B, 0x7FFB,
 0xFFFB, 0xFFFB, 0x3FFB, 0x3FFB, 0x3FFB, 0x3FFF, 0x3FFF, 0x3FFF,
 0x3FFF, 0x3FFF, 0x5FFF, 0xDFE7, 0x3F83, 0x3F7F, 0x7FFF, 0xFFFF,
 0xFFFF, 0xFFFF, 0xBFFF, 0x3F83, 0xDF87, 0xDF0F, 0x3FDF, 0x3FEF,
 0x3FFF, 0x3FFF, 0x3FFF, 0x3FFB, 0x3FFB, 0x3FFB, 0xFFFB, 0xFFFB,
 0xBFFB, 0x3F7F, 0xDF83, 0xDF0F, 0x3FDF, 0x3FEF, 0x3FFF, 0x3FFF,
 0x3FFF, 0x3FFF, 0x3FFF, 0x3FFF, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF},
// 第2组
{0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0x7B03, 0x7B03, 0x7B03,
 0x1BDF, 0x1BDF, 0x7B03, 0x7B03, 0x7B03, 0xFFFF, 0xFFFF, 0xBFFF,
 0x3F83, 0xDF0B, 0x9F1B, 0x1BFB, 0x1BEB, 0x1BE3, 0x1FDF, 0x5FCF,
 0xDFC5, 0x5FCF, 0x1FDF, 0x1BE3, 0x1BEB, 0x1BFB, 0x9F1B, 0xDF0B,
 0x3F83, 0xBFFF, 0xFFFF, 0xFFF3, 0xFFC3, 0xFF4F, 0x3F7F, 0xDF8B,
 0x7F8B, 0x7F8B, 0x7F8B, 0x7B8B, 0x3F9B, 0x7F8B, 0x7F8B, 0x7F8B,
 0xFFFF, 0xFF7F, 0x7FF7, 0xBFCF, 0x1BFB, 0xBFFF, 0x7FFF, 0xFF7F,
 0x1BE3, 0xBFFF, 0x7FFF, 0xFF7F, 0x1BDF, 0xFFFF, 0xFFFF, 0xFFFF},
// 第3组
{0xFFFF, 0xFFFF, 0xFDFF, 0xF9DF, 0xFBCF, 0xBFFF, 0xFBF7, 0xF9EF,
 0xFDCF, 0xFBDF, 0xBFFF, 0xFFF7, 0xFFFF, 0xFFFF, 0xFF83, 0x3F8B,
 0x9F9B, 0x9B1B, 0x991B, 0x19FB, 0x19EB, 0x1BE3, 0x1FE3, 0x5FCF,
 0x1FE3, 0x1BE3, 0x19EB, 0x19FB, 0x991B, 0x9B1B, 0x9F9B, 0x3F8B,
 0x9F9B, 0x9B1B, 0x991B, 0x19FB, 0x19EB, 0x1BE3, 0x1FE3, 0x5FCF,
 0x1FE3, 0x1BE3, 0x19EB, 0x19FB, 0x991B, 0x9B1B, 0x9F9B, 0x3F8B,
 0xFF83, 0xFFFF, 0xFFFF, 0xFDFF, 0xF9EF, 0xFBE7, 0x7F07, 0xFBFB,
 0xF9F7, 0xFDE7, 0xFBEF, 0x7F07, 0xFFFB, 0xFFFF, 0xFFFF, 0xFFFF}
};
